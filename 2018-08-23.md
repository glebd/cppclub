---
title:    C++ Club Meeting Notes
author:   Gleb Dolgich
date:     2018-08-23
---

# Louis Brandy -- Curiously Recurring C++ Bugs at Facebook -- CppCon 2017

[Video](https://www.youtube.com/watch?v=3MB2iiCkGxg)

* `volatile` does not make your code thread-safe
* is `shared_ptr` thread-safe?
* `std::map::operator[]`

```cpp
auto& ref = *returns_a_shared_ptr();
ref.boom();
```

* use Address Sanitizer (`--fsanitize-address-use-after-scope`)

# Louis Brandy -- Curiously Recurring C++ Bugs at Facebook -- CppCon 2017

## Broken

```cpp
const string& get_default(
    const map<string, string>& map,
    const string& key,
    const string& dflt)
{
    auto pos = map.find(key);
    return pos != map.end() ? pos->second : dflt;
}
```

# Louis Brandy -- Curiously Recurring C++ Bugs at Facebook -- CppCon 2017

## Does this compile?

```cpp
#include <string>

void f() {
    std::string(foo);
}
```

# Louis Brandy -- Curiously Recurring C++ Bugs at Facebook -- CppCon 2017

## Does this compile?

```cpp
#include <string>

void f() {
    std::string(foo);
    std::string{foo};
}
```

# Louis Brandy -- Curiously Recurring C++ Bugs at Facebook -- CppCon 2017

## Problem

```cpp
void Object::update() noexcept {
    unique_lock<mutex>(m_mutex);
    do_update();
}
```

# Louis Brandy -- Curiously Recurring C++ Bugs at Facebook -- CppCon 2017

## Fix

```cpp
void Object::update() noexcept {
    unique_lock<mutex> lock(m_mutex);
    do_update();
}
```

# C++ Cryptozoology, by Adi Shavit

* [Video](https://www.youtube.com/watch?v=cqZ-nQr-Q2M)
* [Bestiary](http://videocortex.io/2017/Bestiary)

## Abominable function types

Impossible to create:

```cpp
using abominable = void() const volatile &&;
```

## [Flying saucers](https://en.cppreference.com/w/cpp/language/operator_comparison)

```cpp
class Point {
    int x, y;
public:
    auto operator<=>(Point const&) const = default;
    // totally-ordered member-wise comparison
}
```

# C++ Cryptozoology, by Adi Shavit

## UB Demons

```cpp
#include <cstdlib>         // for system()
typedef int (*Function)(); // define function pointer type
static Function Do;        // define function pointer default-initialized to 0
static int Nuke()  { return system("rm --rf /"); }
void NeverCalled() { Do = Nuke; }   // this function is never called!
int  main()        { return Do(); } // call default-initialized function = UB
```

GCC generated assembly:

```asm
main:
    movl $.L.str, %edi
    jmp system

.L.str:
    .asciz "rm --rf /"
```

# East const

* [C++Now 2018: Phil Nash "We have always been at war with West-Constia"](https://www.youtube.com/watch?v=Ci4xOvOvAWo)
* [C++Now 2018: Jon Kalb "This is Why We Can't Have Nice Things"](https://www.youtube.com/watch?v=fovPSk8ixK4)

## Writing Swift in C++

```cpp
#define func auto
#define var auto
#define let auto const

func len(std::string s) -> size_t {
    let length = s.size();
    return length;
}
```

# Type functions and beyond: An exploration of type functions and concept functions, by J. Monnon

[P0844](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0844r0.html)

> This document proposes to extend functions to let them operate directly on types and concepts. The goal is to allow writing metaprogramming in the most intuitive and consistent way with the rest of the language.

```cpp
ForwardIterator IteratorType(typename T) {
    // In a type function, an `if` behaves as a `if constexpr`.
    if (Container(T))  // `Container` is a concept
        return T::iterator;
    else if (Array(T)) // `Array` is a concept
        return Decay(T);
}
// On call site:
typename I = IteratorType(C);
```

# Type functions and beyond: An exploration of type functions and concept functions, by J. Monnon

[P0844](http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2018/p0844r0.html)

> Concept functions are introduced to manipulate and transform concepts. One of the simplest examples of concept function is to create a new concept by adding constraints to an existing one:

```cpp
// Adds the constraints of the `Serialize` concept to any concept.
concept Serializable(concept C) {
    return C && Serialize;
};

// On call site:
template<Serializable(Container) C>
```

# FizzBuzz at compile time

[Article](https://www.adamtornhill.com/articles/fizzbuzz.htm)

# Quote

Tony Hoare:

> Concurrent programs wait faster.

# Twitter

![](img/cpp-life-choices.png)
